<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>Insert title here</title>
    <link rel="stylesheet" href="upload.css" type="text/css">
</head>
<body>
<div id="body">
    <div id="wrapper">
        <div class="file-choose"><a href="javascript: void(0);" class="choose-icon"
                                    data-action="a.className.choose-icon">‚®Å</a></div>
        <div class="uploadList-wrapper">
            <ul class="uploadList"></ul>
        </div>
    </div>
</div>
<script src="utils.js"></script>
<script src="utils.dom.js"></script>
<script src="service.js"></script>
<script src="excutionQueen.js"></script>
<script>
    this.multiple = true;
    this.fileChoose = null;

    var filterElemByClass = UTIL.dom.filterElemByClass;
    var addDomEvent = UTIL.addDomEvent;
    var removeDomEvent = UTIL.removeDomEvent;
    var ensureAfterDomRenderer = UTIL.ensureAfterDomRenderer;
    var removeClass = UTIL.dom.removeClass;

    var sendBase64 = function (FormData) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
        }
        xhr.upload.onprogress = function (evt) {
        };
        xhr.open("post", 'php/1.php');
        xhr.send(FormData);
    };

    var _createUploadInput = function (up) {
        var fileSelector = document.createElement('input');
        fileSelector.setAttribute('type', 'file');
        if (up.multiple) fileSelector.setAttribute('multiple', 'multiple');
        return fileSelector;
    };
    var onChooseFile = function () {
        var up = this;
        var fileChoose = _createUploadInput(up);
        this.fileChoose = fileChoose;
        addDomEvent(fileChoose, 'change', function () {
            onChangeFiles.call(up);
        });
        if (fileChoose) fileChoose.click();
    };
    var onChangeFiles = function () {
        var fileChoose = this.fileChoose;
        if (fileChoose) {
            var files = fileChoose.files;
            for (var i = 0, l = files.length; i < l; i++) {
                var file = files[i];
                var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;
                var start = 0;

                var fd = new FormData();
                if (file.size < 65535) {
                    fd.append("files[]", file);
                } else {
                    start = 0
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = parseInt(1 * file.size / 5);
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = parseInt(2 * file.size / 5);
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = parseInt(3 * file.size / 5);
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = file.size - 12288;
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                }
                sendBase64(fd);
            }
        }
    };
    var event = new EventService({
        parent: document.getElementById('wrapper'),
        actionMap: {
            'a.className.choose-icon': function (target, e) {
                onChooseFile.call();
            }
        }});
</script>
</body>
</html>