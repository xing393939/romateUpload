<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <title>Insert title here</title>
    <link rel="stylesheet" href="upload.css" type="text/css">
</head>
<body>
<div id="body">
    <div id="wrapper">
        <div class="file-choose"><a href="javascript: void(0);" class="choose-icon"
                                    data-action="a.className.choose-icon">‚®Å</a></div>
        <div class="uploadList-wrapper">
            <ul class="uploadList"></ul>
        </div>
    </div>
</div>
<script src="utils.js"></script>
<script src="utils.dom.js"></script>
<script src="service.js"></script>
<script src="excutionQueen.js"></script>
<script src="jsonp.js"></script>
<script src="queenRetrieveData.js"></script>
<script src="data.js"></script>
<script src="spark-md5.js"></script>
<script>
    this.multiple = true;
    this.fileChoose = null;

    var filterElemByClass = UTIL.dom.filterElemByClass;
    var addDomEvent = UTIL.addDomEvent;
    var removeDomEvent = UTIL.removeDomEvent;
    var ensureAfterDomRenderer = UTIL.ensureAfterDomRenderer;
    var removeClass = UTIL.dom.removeClass;

    var sendPost = function (url, FormData, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    callback(xhr.responseText);
                }
            }
        }
        xhr.upload.onprogress = function (evt) {
        };
        xhr.open("post", url);
        xhr.send(FormData);
    };
    var str2ab_blobreader = function(str, callback) {
   	    var blob;
   	    BlobBuilder = window.MozBlobBuilder || window.WebKitBlobBuilder || window.BlobBuilder;
   	    if (typeof(BlobBuilder) !== 'undefined') {
   	      var bb = new BlobBuilder();
   	      bb.append(str);
   	      blob = bb.getBlob();
   	    } else {
   	      blob = new Blob([str]);
   	    }
   	    var f = new FileReader();
   	    f.onload = function(e) {
   	        callback(e.target.result)
   	    }
   	    f.readAsArrayBuffer(blob);
   	};
    var sendFile = function (url, chunk, callback) {
        xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function(){
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    callback(xhr.responseText);
                }
            }
        };
        xhr.addEventListener("load",  function (evt) {
        }, false);

        xhr.upload.addEventListener('progress', function (evt) {
        }, false);

        xhr.open('post', url, true);
        xhr.setRequestHeader('Content-type','application/x-www-form-urlencoded');
        if (File.prototype.webkitSlice) {
            // android default browser in version 4.0.4 has webkitSlice instead of slice()
            var buffer = str2ab_blobreader(chunk, function(buf) {
                xhr.send(buf);
            });
        } else {
            xhr.send(chunk);
        }
    }

    var _createUploadInput = function (up) {
        var fileSelector = document.createElement('input');
        fileSelector.setAttribute('type', 'file');
        if (up.multiple) fileSelector.setAttribute('multiple', 'multiple');
        return fileSelector;
    };
    var onChooseFile = function () {
        var up = this;
        var fileChoose = _createUploadInput(up);
        this.fileChoose = fileChoose;
        addDomEvent(fileChoose, 'change', function () {
            onChangeFiles.call(up);
        });
        if (fileChoose) fileChoose.click();
    };
    var onChangeFiles = function () {
        var fileChoose = this.fileChoose;
        if (fileChoose) {
            var files = fileChoose.files;
            for (var i = 0, l = files.length; i < l; i++) {
                var file = files[i];
                var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice;
                var start = 0;

                var fd = new FormData();
                fd.append("size", file.size);
                if (file.size < 65535) {
                    fd.append("files[]", file);
                } else {
                    start = 0
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = parseInt(1 * file.size / 5);
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = parseInt(2 * file.size / 5);
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = parseInt(3 * file.size / 5);
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                    start = file.size - 12288;
                    fd.append("files[]", blobSlice.call(file, start, start + 12288));
                }
                if (file.size < 61440) {
                    fd.append("files2[]", file);
                } else {
                    start = 0
                    fd.append("files2[]", blobSlice.call(file, start, start + 20480));
                    start = parseInt(1 * file.size / 3);
                    fd.append("files2[]", blobSlice.call(file, start, start + 20480));
                    start = file.size - 20480;
                    fd.append("files2[]", blobSlice.call(file, start, start + 20480));
                }

                var spark = new SparkMD5.ArrayBuffer();
                var fileReader = new FileReader();
                sendPost('php/api_ppFeature.php', fd, function (str) {
                    eval('ppFeatureArr=' + str);
                    ppFeature = ppFeatureArr.data.ppFeature;

                    var visitData = new Data({
                        params: {
                            PPKey: encodeURIComponent('hN3i3oup4BmWrUYH5QNyfbgTXxnvCMqGz++dZ381W8EPyU9WN2kKiKEZxLii/F9CYyq7+0Q2rhJoxK2NYenS+scGcOfGhK3h'),
                            userName: 'wengjiawei9',
                            categoryid: 930,
                            channelname: 'test_upload',
                            channeltype: 1,
                            ppfeature: ppFeature,
                            series_id: 182,
                            //series_id: 265,
                            size: file.size,
                            summary: 'test_summary'
                        },
                        requestProxy: queenRetrieveData,
                        requestOption: {
                            apiUrl: 'http://share.pptv.com/api/video/list/save-channel',
                            param: '',
                            callback: function (data) {
                                var fd = new FormData();
                                sendPost('php/api_upload.php', fd, function (str) {
                                    var fd = new FormData();
                                    fd.append("fid", data.data.fid)
                                    fd.append("feature_pplive", ppFeature)
                                    //fd.append("md5", '6DC6816D407CBB1C0F85AC03A062F27B')
                                    sendPost('php/api_uploading.php', fd, function (str) {
                                        var fd = new FormData();
                                        fd.append("fid", data.data.fid)
                                        fd.append("feature_pplive", ppFeature)
                                        fd.append("xunlei_cid", ppFeatureArr.data.xunlei_cid)
                                        sendPost('php/api_features.php', fd, function (str) {
                                            var fd = new FormData();
                                            fd.append("fid", data.data.fid)
                                            fd.append("feature_pplive", ppFeature)
                                            sendPost('php/api_uploadrange.php', fd, function (str) {
                                                eval('arr=' + str);

                                                chunk = blobSlice.call(file, arr.data.ranges[0].start, arr.data.ranges[0].end);
                                                //console.log(chunk);
                                                console.log('fid:'+data.data.fid, arr.data.ranges[0].start, arr.data.ranges[0].end, arr.data.ranges[0].bid);
                                                fileReader.onload = function (e) {
                                                    spark.append(e.target.result);
                                                    var params = '?fid=' + data.data.fid;
                                                    params += '&bid=' + arr.data.ranges[0].bid;
                                                    params += '&range_md5=' + spark.end();
                                                    params += '&upload_url=' + encodeURIComponent(arr.data.ranges[0].upload_url);
                                                    sendFile('php/api_uploaded.php' + params, chunk, function (str) {
                                                        console.log(str);
                                                    });
                                                };
                                                fileReader.readAsArrayBuffer(chunk);
                                            })
                                        });
                                    });
                                });
                            },
                            errorCallback: function () {
                                visitData.reset();
                            }
                        }
                    });
                    visitData.nextRequest();
                });
            }
        }
    };
    var event = new EventService({
        parent: document.getElementById('wrapper'),
        actionMap: {
            'a.className.choose-icon': function (target, e) {
                onChooseFile.call();
            }
        }});
</script>
</body>
</html>